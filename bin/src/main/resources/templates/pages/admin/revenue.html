<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/admin-layout :: view(~{::title}, ~{::article})}">
<head>
  <title>Admin - Báo cáo doanh thu</title>
</head>
<body>
  <article>
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Báo cáo doanh thu</h3>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <div class="row g-2">
            <div class="col-md-3"><input id="fromDate" type="date" class="form-control"></div>
            <div class="col-md-3"><input id="toDate" type="date" class="form-control"></div>
            <div class="col-md-3"><button class="btn btn-dark w-100" id="btnCalc">Tính doanh thu</button></div>
          </div>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card">
            <div class="card-body">
              <h6 class="text-muted">Tổng doanh thu</h6>
              <div class="display-6" id="sumRevenue">0 đ</div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card">
            <div class="card-body">
              <h6 class="text-muted">Số đơn hàng</h6>
              <div class="display-6" id="sumOrders">0</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-body">
          <h6 class="mb-3">Chi tiết theo đơn</h6>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr><th>Mã đơn</th><th>Ngày</th><th>Khách</th><th class="text-end">Tổng tiền</th></tr>
              </thead>
              <tbody id="revBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  <script>
    function money(n){ try{ return new Intl.NumberFormat('vi-VN').format(n)+' đ'; }catch(e){ return n; } }
    function formatDate(dt){ 
      if(!dt) return '';
      const d = new Date(dt);
      return d.toLocaleDateString('vi-VN') + ' ' + d.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
    }

    async function calcRevenue(){
      let url = '/admin/api/revenue?';
      if(fromDate.value) url += `startDate=${fromDate.value}T00:00:00&`;
      if(toDate.value) url += `endDate=${toDate.value}T23:59:59`;
      
      const res = await fetch(url);
      const data = await res.json();
      
      sumRevenue.textContent = money(data.totalRevenue||0);
      sumOrders.textContent = data.totalOrders||0;
      
      let ordersUrl = '/admin/api/revenue/orders?';
      if(fromDate.value) ordersUrl += `startDate=${fromDate.value}T00:00:00&`;
      if(toDate.value) ordersUrl += `endDate=${toDate.value}T23:59:59`;
      
      const ordersRes = await fetch(ordersUrl);
      const orders = await ordersRes.json();
      
      revBody.innerHTML = orders.map(o=>`<tr><td>ORD-${String(o.id).padStart(3, '0')}</td><td>${formatDate(o.orderDate)}</td><td>${o.customerName||''}</td><td class="text-end">${money(o.totalAmount||0)}</td></tr>`).join('');
    }

    document.addEventListener('DOMContentLoaded', function(){
      btnCalc.addEventListener('click', calcRevenue);
      calcRevenue();
    });
  </script>
  </article>
</body>
</html>
