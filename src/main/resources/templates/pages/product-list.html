<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: view(~{::title}, ~{::article})}">
<head>
  <title>Khuyến mãi - Danh sách sản phẩm</title>
</head>
<body>
  <article>
    <div class="container">
      <!-- breadcrumb + tổng số -->
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
              <li class="breadcrumb-item"><a th:href="@{/pages/home}">Trang chủ</a></li>
              <li class="breadcrumb-item active" aria-current="page">Ưu đãi</li>
            </ol>
          </nav>
          <div class="text-muted small" th:text="${page.totalElements} + ' Sản phẩm'"></div>
        </div>
        <!-- filters + sort -->
        <form class="d-flex gap-2 align-items-center" th:action="@{/products}" method="get">
          <input class="form-control form-control-sm" style="width:220px" type="search" name="q" placeholder="Tìm kiếm" th:value="${params['q']}">
          <select class="form-select form-select-sm" style="width:200px" name="category">
            <option value="" th:selected="${params['category']==null || params['category']==''}">Tất cả danh mục</option>
            <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"
                    th:selected="${params['category']!=null and params['category']!='' and params['category']==c.id.toString()}"></option>
          </select>
          <input class="form-control form-control-sm" style="width:110px" type="number" min="0" step="1000" name="min" placeholder="Giá từ" th:value="${params['min']}">
          <input class="form-control form-control-sm" style="width:110px" type="number" min="0" step="1000" name="max" placeholder="Giá đến" th:value="${params['max']}">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="sale" value="1" th:checked="${params['sale']=='1'}" id="chkSale">
            <label class="form-check-label" for="chkSale">Giảm giá</label>
          </div>
          <select class="form-select form-select-sm" style="width:160px" name="sort" th:value="${params['sort']}">
            <option value="popular" th:selected="${params['sort']=='popular'}">Phổ biến</option>
            <option value="priceAsc" th:selected="${params['sort']=='priceAsc'}">Giá thấp - cao</option>
            <option value="priceDesc" th:selected="${params['sort']=='priceDesc'}">Giá cao - thấp</option>
            <option value="newest" th:selected="${params['sort']=='newest'}">Mới nhất</option>
          </select>
          <input type="hidden" name="size" th:value="${params['size']}">
          <button class="btn btn-sm btn-dark" type="submit">Lọc</button>
        </form>
      </div>

      <!-- grid sản phẩm -->
      <div class="row g-3">
        <div class="col-12" th:if="${#lists.isEmpty(items)}">
          <div class="alert alert-info">Không tìm thấy sản phẩm phù hợp.</div>
        </div>
        <div class="col-6 col-md-4 col-lg-3" th:each="item : ${items}">
          <div class="card h-100">
            <div class="position-relative">
              <span class="badge bg-danger position-absolute top-0 start-0 m-2"
                    th:if="${item.discount != null and item.discount.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
                    th:text="${'-' + #numbers.formatDecimal(item.discount, 0, 0) + '%'}">-20%</span>
              <a th:href="@{'/product/detail/' + ${item.id}}">
                <img class="card-img-top" alt="product" loading="lazy"
                     th:src="${#strings.isEmpty(item.image) ? '/images/placeholder.svg' : item.image}"
                     onerror="this.onerror=null;this.src='/images/placeholder.svg';">
              </a>
            </div>
            <div class="card-body">
              <div class="d-flex align-items-center gap-2 mb-1">
                <strong th:text="${#numbers.formatDecimal(item.salePrice, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</strong>
                <span class="text-muted text-decoration-line-through small"
                      th:if="${item.discount != null and item.discount.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
                      th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</span>
              </div>
              <h6 class="card-title mb-0">
                <a class="stretched-link text-reset" th:href="@{'/product/detail/' + ${item.id}}" th:text="${item.name}">Tên sản phẩm</a>
              </h6>
            </div>
          </div>
        </div>
      </div>

      <!-- phân trang -->
      <nav class="mt-4" th:if="${page.totalPages > 1}"
           th:with="curr=${page.number}, total=${page.totalPages},
                     start=${(page.number-2) < 0 ? 0 : (page.number-2)},
                     end=${(page.number+2) > (page.totalPages-1) ? (page.totalPages-1) : (page.number+2)}">
        <ul class="pagination justify-content-center">
          <!-- Prev -->
          <li class="page-item" th:if="${!page.first}">
            <a class="page-link" th:href="@{/products(page=${curr-1},size=${params['size']},sort=${params['sort']},q=${params['q']},category=${params['category']},min=${params['min']},max=${params['max']},sale=${params['sale']})}">Trước</a>
          </li>
          <li class="page-item disabled" th:if="${page.first}"><span class="page-link">Trước</span></li>

          <!-- First 3 pages -->
          <li class="page-item"
              th:each="i : ${#numbers.sequence(0, (total-1 < 2 ? total-1 : 2))}"
              th:classappend="${i==curr} ? 'active'"
              th:if="${start > 0}">
            <a class="page-link" th:text="${i+1}"
               th:href="@{/products(page=${i},size=${params['size']},sort=${params['sort']},q=${params['q']},category=${params['category']},min=${params['min']},max=${params['max']},sale=${params['sale']})}">1</a>
          </li>
          <li class="page-item disabled" th:if="${start > 3}"><span class="page-link">…</span></li>

          <!-- Middle window -->
          <li class="page-item" th:each="i : ${#numbers.sequence(start, end)}" th:classappend="${i==curr} ? 'active'">
            <a class="page-link" th:text="${i+1}"
               th:href="@{/products(page=${i},size=${params['size']},sort=${params['sort']},q=${params['q']},category=${params['category']},min=${params['min']},max=${params['max']},sale=${params['sale']})}">1</a>
          </li>

          <!-- Last 3 pages -->
          <li class="page-item disabled" th:if="${end < total-4}"><span class="page-link">…</span></li>
          <li class="page-item"
              th:each="i : ${#numbers.sequence((total-3 < 0 ? 0 : total-3), total-1)}"
              th:if="${end < total-1}"
              th:classappend="${i==curr} ? 'active'">
            <a class="page-link" th:text="${i+1}"
               th:href="@{/products(page=${i},size=${params['size']},sort=${params['sort']},q=${params['q']},category=${params['category']},min=${params['min']},max=${params['max']},sale=${params['sale']})}">1</a>
          </li>

          <!-- Next -->
          <li class="page-item" th:if="${!page.last}">
            <a class="page-link" th:href="@{/products(page=${curr+1},size=${params['size']},sort=${params['sort']},q=${params['q']},category=${params['category']},min=${params['min']},max=${params['max']},sale=${params['sale']})}">Sau</a>
          </li>
          <li class="page-item disabled" th:if="${page.last}"><span class="page-link">Sau</span></li>
        </ul>
      </nav>
    </div>

  <script>
    // Simple add-to-cart using localStorage
    (function(){
      function updateBadge(){
        const badge = document.getElementById('cartCountBadge');
        try{
          const cart = JSON.parse(localStorage.getItem('cart')||'[]');
          const count = cart.reduce((s,i)=>s+(parseInt(i.qty||1)||1),0);
          if(badge){
            if(count>0){ badge.style.display='inline-block'; badge.textContent = count; }
            else { badge.style.display='none'; }
          }
        }catch(e){}
      }
      function addItem(data){
        const cart = JSON.parse(localStorage.getItem('cart')||'[]');
        const idx = cart.findIndex(x=>x.id===data.id);
        if(idx>-1){ cart[idx].qty = (parseInt(cart[idx].qty||1)||1) + 1; }
        else { cart.push({id:data.id, title:data.title, price:data.price, img:data.img, qty:1}); }
        localStorage.setItem('cart', JSON.stringify(cart));
        updateBadge();
      }
      document.querySelectorAll('.add-to-cart').forEach(btn=>{
        btn.addEventListener('click', function(){
          const d = this.dataset;
          addItem({id:d.id, title:d.title, price:parseInt(d.price), img:d.img});
          this.classList.add('btn-success');
          this.textContent = '✓';
          setTimeout(()=>{ this.classList.remove('btn-success'); this.textContent = '+'; }, 800);
        });
      });
      // Navigate to product-detail with query params
      document.querySelectorAll('.to-detail').forEach(a=>{
        a.addEventListener('click', function(e){
          e.preventDefault();
          const d = this.dataset;
          const qs = new URLSearchParams({id:d.id, title:d.title, price:d.price, img:d.img});
          window.location.href = '/pages/product-detail?' + qs.toString();
        });
      });
      updateBadge();
    })();
  </script>
  </article>
</body>
</html>
