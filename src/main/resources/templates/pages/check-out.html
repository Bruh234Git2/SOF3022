<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: view(~{::title}, ~{::article})}">
<head>
  <title>Thanh toán</title>
    <meta charset="utf-8">
</head>
<body>
  <article>
    <div class="container">
      <h3 class="mb-3">Thanh toán</h3>
      <div class="row g-4">
        <!-- thông tin người nhận -->
        <div class="col-lg-8">
          <div class="card">
            <div class="card-body">
				<h5 class="card-title">Thông tin người nhận</h5>
				<form id="checkoutForm">
				  <div class="row g-3">
				    <div class="col-md-6">
				      <label class="form-label">Họ và tên</label>
				      <input type="text" class="form-control" name="fullName" placeholder="Nguyễn Văn A" required>
				    </div>
				    <div class="col-md-6">
				      <label class="form-label">Số điện thoại</label>
				      <input type="tel" class="form-control" name="phone" placeholder="09xx xxx xxx" required>
				    </div>
				    <div class="col-12">
				      <label class="form-label">Email</label>
				      <input type="email" class="form-control" name="email" placeholder="you@example.com" required>
				    </div>
				    <div class="col-12">
				      <label class="form-label">Địa chỉ</label>
				      <input type="text" class="form-control" name="address" placeholder="Số nhà, đường, phường/xã, quận/huyện, tỉnh/thành" required>
				    </div>
				    <div class="col-md-6">
				      <label class="form-label">Phương thức thanh toán</label>
				      <select class="form-select" name="paymentMethod">
				        <option value="COD">COD - Thanh toán khi nhận hàng</option>
				        <option value="BANKING">Chuyển khoản</option>
				        <option value="EWALLET">Ví điện tử</option>
				      </select>
				    </div>
				    <div class="col-md-6">
				      <label class="form-label">Ghi chú</label>
				      <input type="text" class="form-control" name="notes" placeholder="Giao giờ hành chính...">
				    </div>
				  </div>
				  </form>
            </div>
          </div>
        </div>
        <!-- tóm tắt đơn hàng -->
        <div class="col-lg-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Đơn hàng</h5>
              <div id="orderItems"></div>
              <div class="d-flex justify-content-between border-top pt-2">
                <span>Tạm tính</span><strong id="ckSubtotal">0 đ</strong>
              </div>
              <div class="d-flex justify-content-between">
                <span>Giảm giá</span><strong id="ckDiscount" class="text-success">0 đ</strong>
              </div>
              <div class="d-flex justify-content-between">
                <span>Phí vận chuyển</span><strong id="ckShipping">0 đ</strong>
              </div>
              <div class="d-flex justify-content-between border-top pt-2 mt-2">
                <span>Thành tiền</span><strong id="ckTotal" class="fs-5">0 đ</strong>
              </div>
              <button id="btnPlaceOrder" class="btn btn-dark w-100 mt-3">Đặt hàng</button>
            </div>
          </div>
        </div>
      </div>
    </div>
	<script>
	    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
	    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
	    
	    function vnd(n){ try{ return new Intl.NumberFormat('vi-VN').format(n)+' đ'; }catch(e){ return n+' đ'; } }
	    
	    // Load cart từ backend API
	    async function loadCart(){
	      try{
	        const headers = {};
	        if (csrfHeader && csrfToken) {
	          headers[csrfHeader] = csrfToken;
	        }
	        const res = await fetch('/api/cart/items', { headers });
	        if(!res.ok) return [];
	        return await res.json();
	      }catch(e){ console.error(e); return []; }
	    }
	    
	    async function renderCheckout(){
	      const wrap = document.getElementById('orderItems');
	      const items = await loadCart();
	      wrap.innerHTML = '';
	    
	      if(items.length === 0){
	        wrap.innerHTML = '<div class="text-muted small">Giỏ hàng trống</div>';
	      } else {
	        items.forEach(item => {
	          const prod = item.product || {};
	          const qty = item.quantity || 1;
	          const price = prod.salePrice || 0;
	          const row = document.createElement('div');
	          row.className = 'd-flex align-items-center justify-content-between mb-2';
	          row.innerHTML = `
	            <div class="d-flex align-items-center gap-2">
	              <img src="${prod.image || '/images/placeholder.svg'}" width="54" height="54" class="rounded" style="object-fit:cover" alt="img" onerror="this.src='/images/placeholder.svg'">
	              <div>
	                <div class="small">${prod.name || 'Sản phẩm'} x${qty}</div>
	                <div class="text-muted small">${item.color ? `Màu: ${item.color} • ` : ''}${item.size ? `Size: ${item.size}` : ''}</div>
	                <div class="text-muted small">${vnd(price)}</div>
	              </div>
	            </div>
	            <span>${vnd(price * qty)}</span>
	          `;
	          wrap.appendChild(row);
	        });
	      }
	    
	      const subtotal = items.reduce((s, item) => {
	        const prod = item.product || {};
	        const price = prod.salePrice || 0;
	        const qty = item.quantity || 1;
	        return s + (price * qty);
	      }, 0);
	      const discount = 0; // demo
	      const shipping = subtotal>0 ? 30000 : 0;
	      const total = subtotal - discount + shipping;
	      document.getElementById('ckSubtotal').textContent = vnd(subtotal);
	      document.getElementById('ckDiscount').textContent = '-' + vnd(discount).replace(' đ',' đ');
	      document.getElementById('ckShipping').textContent = vnd(shipping);
	      document.getElementById('ckTotal').textContent = vnd(total);
	    }
	    
	    document.addEventListener('DOMContentLoaded', function(){
	      renderCheckout();
	      
	      const btn = document.getElementById('btnPlaceOrder');
	      const form = document.getElementById('checkoutForm');
	    
	      if(btn){
	        btn.addEventListener('click', async function(){
	          
	          // 1. Lấy form và kiểm tra validation
	          if (!form.checkValidity()) {
	            form.reportValidity();
	            return;
	          }
	    
	          const shippingInfo = Object.fromEntries(new FormData(form).entries());
	          const cartEntities = await loadCart();
	    
	          if (cartEntities.length === 0) {
	            alert('Giỏ hàng của bạn đang trống!');
	            return;
	          }
	    
	          const cartItems = cartEntities
	            .map(it => ({
	              productId: it.product?.id,
	              qty: it.quantity || 1,
	              color: it.color,
	              size: it.size
	            }))
	            .filter(it => it.productId);
	    
	          if (cartItems.length === 0) {
	            alert('Không tìm thấy sản phẩm hợp lệ trong giỏ hàng!');
	            return;
	          }
	    
	          const payload = {
	            shippingInfo: shippingInfo,
	            cartItems: cartItems 
	          };
	    
			  btn.disabled = true;
			  btn.textContent = 'Đang xử lý...';
	    
			  const token = csrfToken;
			  const header = csrfHeader;
	    
			  const headers = { 'Content-Type': 'application/json' };
			  if (header && token) {
			    headers[header] = token;
			  }
	    
			  fetch('/orders/place', {
			    method: 'POST',
			    headers: headers,
			    body: JSON.stringify(payload)
			  })
	          .then(response => {
	            if (response.ok) {
	              return response.text();
	            }
	            return response.text().then(text => { 
	                throw new Error('Lỗi từ server: ' + text); 
	            });
	          })
			  .then(data => {
			    alert('Đặt hàng thành công!');
			    window.location.href = '/pages/thank-you';
			  })
			  .catch(error => {
			    console.error('Lỗi đặt hàng:', error);
	            alert('Có lỗi xảy ra khi đặt hàng:\n' + error.message);
			  })
	          .finally(() => {
	            btn.disabled = false;
	            btn.textContent = 'Đặt hàng';
	          });
	        });
	      }
	    });
	  </script>
  </article>
</body>
</html>
