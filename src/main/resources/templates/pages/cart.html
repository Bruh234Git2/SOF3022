<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: view(~{::title}, ~{::article})}">
<head>
  <title>Giỏ hàng</title>
</head>
<body>
  <article>
    <div class="container">
      <h3 class="mb-3">Giỏ hàng</h3>
      <div class="row g-4">
        <div class="col-lg-8">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Sản phẩm</th>
                  <th class="text-center">Số lượng</th>
                  <th class="text-end">Đơn giá</th>
                  <th class="text-end">Thành tiền</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="cartBody"></tbody>
            </table>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Tổng cộng</h5>
              <div class="d-flex justify-content-between"><span>Tạm tính</span><strong id="subtotalValue">0 đ</strong></div>
              <div class="d-flex justify-content-between"><span>Giảm giá</span><strong id="discountValue" class="text-success">0 đ</strong></div>
              <div class="d-flex justify-content-between"><span>Phí vận chuyển</span><strong id="shippingValue">0 đ</strong></div>
              <div class="d-flex justify-content-between border-top pt-2 mt-2">
                <span>Thành tiền</span><strong id="totalValue" class="fs-5">0 đ</strong>
              </div>
              <a th:href="@{/pages/check-out}" class="btn btn-dark w-100 mt-3">Thanh toán</a>
              <a th:href="@{/products}" class="btn btn-outline-dark w-100 mt-2">Tiếp tục mua sắm</a>
            </div>
          </div>
        </div>
      </div>
    </div>

  <script>
    // CSRF token helper
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    // Currency format helper
    function vnd(n){
      try{ return new Intl.NumberFormat('vi-VN').format(n) + ' đ'; }catch(e){ return n + ' đ'; }
    }

    // Load cart từ backend API
    async function loadCart(){
      try{
        const res = await fetch('/api/cart/items', {
          headers: { [csrfHeader]: csrfToken }
        });
        if(!res.ok) return [];
        return await res.json();
      }catch(e){ console.error(e); return []; }
    }

    // Update quantity
    async function updateQty(cartId, newQty){
      try{
        const res = await fetch(`/api/cart/items/${cartId}`, {
          method: 'PUT',
          headers: { 
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken 
          },
          body: JSON.stringify({qty: newQty})
        });
        return res.ok;
      }catch(e){ console.error(e); return false; }
    }

    // Delete item
    async function deleteItem(cartId){
      try{
        const res = await fetch(`/api/cart/items/${cartId}`, {
          method: 'DELETE',
          headers: { [csrfHeader]: csrfToken }
        });
        return res.ok;
      }catch(e){ console.error(e); return false; }
    }

    // Render cart
    async function renderCart(){
      const body = document.getElementById('cartBody');
      const items = await loadCart();
      body.innerHTML = '';
      
      if(items.length === 0){
        body.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Giỏ hàng trống</td></tr>';
        updateTotals([]);
        return;
      }

      items.forEach((item)=>{
        const prod = item.product || {};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div class="d-flex align-items-center gap-3">
              <img src="${prod.image || '/images/placeholder.svg'}" width="60" height="60" class="rounded" style="object-fit:cover" alt="img" onerror="this.src='/images/placeholder.svg'">
              <div>
                <div class="fw-semibold">${prod.name || 'Sản phẩm'}</div>
                <div class="text-muted small">Mã: ${prod.id}${item.color ? ` • Màu: ${item.color}` : ''}${item.size ? ` • Size: ${item.size}` : ''}</div>
              </div>
            </div>
          </td>
          <td class="text-center" style="width:160px">
            <div class="input-group input-group-sm justify-content-center" style="max-width:140px;">
              <button class="btn btn-outline-secondary" data-action="dec" data-cart-id="${item.id}">-</button>
              <input type="text" class="form-control text-center" value="${item.quantity || 1}" readonly>
              <button class="btn btn-outline-secondary" data-action="inc" data-cart-id="${item.id}">+</button>
            </div>
          </td>
          <td class="text-end">${vnd(prod.salePrice || 0)}</td>
          <td class="text-end">${vnd((prod.salePrice || 0) * (item.quantity || 1))}</td>
          <td class="text-end"><button class="btn btn-sm btn-outline-danger" data-action="del" data-cart-id="${item.id}">Xoá</button></td>
        `;
        body.appendChild(tr);
      });

      // Bind actions
      body.querySelectorAll('[data-action]').forEach(btn=>{
        btn.addEventListener('click', async function(){
          const action = this.getAttribute('data-action');
          const cartId = parseInt(this.getAttribute('data-cart-id'));
          if(isNaN(cartId)) return;

          const currentRow = this.closest('tr');
          const qtyInput = currentRow.querySelector('input[type="text"]');
          let currentQty = parseInt(qtyInput.value) || 1;

          if(action === 'inc'){
            await updateQty(cartId, currentQty + 1);
          } else if(action === 'dec'){
            if(currentQty > 1){
              await updateQty(cartId, currentQty - 1);
            }
          } else if(action === 'del'){
            if(confirm('Xóa sản phẩm này khỏi giỏ hàng?')){
              await deleteItem(cartId);
            }
          }
          
          // Reload cart
          await renderCart();
          // Update navbar badge
          window.location.reload();
        });
      });

      updateTotals(items);
    }

    function updateTotals(items){
      const subtotal = items.reduce((s, item) => {
        const price = item.product?.salePrice || 0;
        const qty = item.quantity || 1;
        return s + (price * qty);
      }, 0);
      
      const discount = 0;
      const shipping = subtotal > 0 ? 30000 : 0;
      const total = subtotal - discount + shipping;

      document.getElementById('subtotalValue').textContent = vnd(subtotal);
      document.getElementById('discountValue').textContent = '-' + vnd(discount);
      document.getElementById('shippingValue').textContent = vnd(shipping);
      document.getElementById('totalValue').textContent = vnd(total);
    }

    document.addEventListener('DOMContentLoaded', function(){
      renderCart();
    });
  </script>
  </article>
</body>
</html>
