<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: view(~{::title}, ~{::article})}">
<head>
  <title>Chi tiết sản phẩm</title>
</head>
<body>
  <article>
    <div class="container">
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb mb-1">
          <li class="breadcrumb-item"><a th:href="@{/pages/home}">Trang chủ</a></li>
          <li class="breadcrumb-item"><a th:href="@{/products}">Sản phẩm</a></li>
          <li class="breadcrumb-item active" aria-current="page">Chi tiết</li>
        </ol>
      </nav>

      <div class="row g-4">
        <!-- gallery -->
        <div class="col-lg-6">
          <style>
            /* gallery sizing - 1:1 like Shopee */
            .pd-aspect{ aspect-ratio: 1/1; width: 100%; border-radius: 8px; overflow: hidden; background: #f7f7f7; }
            .pd-main{ width:100%; height:100%; object-fit: cover; cursor: zoom-in; }
            .pd-thumb{ width: 96px; height: 96px; object-fit: cover; cursor: pointer; border-radius: 6px; }
            .pd-thumb.active{ outline: 2px solid #000; }
            .pd-modal-img{ width: 420px; height: 420px; object-fit: cover; border-radius: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.10); background: #f7f7f7; }
            .pd-modal-wrap{ background:#fff; border-radius:18px; padding:40px 32px; box-shadow: 0 8px 32px rgba(0,0,0,.18); border: 2px solid #e5e7eb; max-width: 900px; margin: auto; }
            .pd-modal-thumbs{ display:flex; flex-direction:column; gap:16px; max-height: 420px; overflow-y:auto; margin-top:8px; }
            .pd-modal-thumb{ width:90px; height:90px; object-fit:cover; cursor:pointer; border-radius:10px; border: 2px solid transparent; transition: border 0.2s; background: #f7f7f7; }
            .pd-modal-thumb.active{ border-color:#ff5722; }
            .pd-nav-btn{ position: absolute; top: 50%; transform: translateY(-50%); border-radius: 50%; font-size: 2rem; width: 44px; height: 44px; z-index: 2; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.10); border: none; }
            @media (min-width: 1400px){ .pd-thumb{ width:104px; height:104px; } }
            @media (max-width: 991px) {
                .pd-modal-img { width: 260px; height: 260px; }
                .pd-modal-thumbs { max-height: 260px; }
                .pd-modal-wrap { padding: 16px 8px; max-width: 98vw; }
            }
            /* custom overlay fallback */
            .pd-overlay{ position: fixed; inset:0; background: rgba(0,0,0,.75); display:none; align-items:center; justify-content:center; z-index: 1055; }
            .pd-overlay.show{ display:flex; }
            .pd-overlay .nav{ position:absolute; top:50%; transform: translateY(-50%); font-size: 1.6rem; color:#111; background:#fff; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; box-shadow: 0 4px 20px rgba(0,0,0,.2); }
            .pd-overlay .prev{ left:16px; }
            .pd-overlay .next{ right:16px; }
            .pd-overlay .close{ position:absolute; top:12px; right:12px; font-size: 1.5rem; background:#fff; border-radius: 6px; padding:4px 10px; cursor:pointer; }
          </style>
          <div class="card mb-3 border-0">
            <div class="pd-aspect">
              <img id="mainImage" class="pd-main" alt="Ảnh sản phẩm" th:src="${#strings.isEmpty(product.image) ? '/images/placeholder.svg' : product.image}"
                   onerror="this.onerror=null;this.src='/images/placeholder.svg';"
                   width="800" height="800" fetchpriority="high" decoding="async">
            </div>
          </div>
          <div id="thumbRow" class="d-flex gap-2">
            <!-- Always include main image as the first thumbnail -->
            <img th:src="${#strings.isEmpty(product.image) ? '/images/placeholder.svg' : product.image}"
                 class="pd-thumb rounded border active"
                 onerror="this.onerror=null;this.src='/images/placeholder.svg';"
                 loading="lazy" decoding="async" width="200" height="200">
            <!-- Then the rest images -->
            <img th:if="${!#lists.isEmpty(images)}" th:each="img : ${images}" th:src="${img.imageUrl}"
                 class="pd-thumb rounded border"
                 onerror="this.onerror=null;this.src='/images/placeholder.svg';"
                 loading="lazy" decoding="async" width="200" height="200">
          </div>

          <!-- Lightbox modal -->
          <div class="modal fade" id="imgLightbox" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" style="max-width:900px;">
              <div class="modal-content bg-transparent border-0">
                <div class="modal-body pd-modal-wrap">
                  <div class="d-flex flex-row align-items-start gap-4">
                    <div class="position-relative d-flex align-items-center justify-content-center" style="min-width:420px;">
                      <button type="button" id="btnPrev" class="btn btn-light pd-nav-btn" style="left:-32px;">‹</button>
                      <img id="lightboxImg" class="pd-modal-img" alt="">
                      <button type="button" id="btnNext" class="btn btn-light pd-nav-btn" style="right:-32px;">›</button>
                    </div>
                    <div style="min-width:120px; max-width:220px;">
                      <div class="mb-2 fw-semibold" th:text="${product.name}">Tên sản phẩm</div>
                      <div id="lbThumbs" class="pd-modal-thumbs"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Fallback overlay if Bootstrap JS not loaded -->
          <div id="pdOverlay" class="pd-overlay">
            <div class="pd-modal-wrap" style="position:relative;">
              <span class="nav prev" id="ovPrev">‹</span>
              <div class="d-flex flex-row align-items-start gap-4">
                <div class="d-flex align-items-center justify-content-center" style="min-width:420px;">
                  <img id="ovImg" class="pd-modal-img" alt="">
                </div>
                <div style="min-width:120px; max-width:220px;">
                  <div class="mb-2 fw-semibold" th:text="${product.name}">Tên sản phẩm</div>
                  <div id="ovThumbs" class="pd-modal-thumbs"></div>
                </div>
              </div>
              <span class="nav next" id="ovNext">›</span>
            </div>
          </div>
        </div>

        <!-- info -->
        <div class="col-lg-6">
          <h2 class="fw-bold" th:text="${product.name}">Tên sản phẩm</h2>
          <div class="d-flex align-items-center gap-2 mb-2">
            <div class="text-warning" th:text="${#numbers.formatDecimal(avgRating,1,1)} + '★'"></div>
            <small class="text-muted" th:text="'(' + ${reviewCount} + ' đánh giá)'">(0 đánh giá)</small>
          </div>
          <div class="mb-3">
            <span class="fs-4 fw-bold" th:text="${#numbers.formatDecimal(product.salePrice, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</span>
            <span class="text-muted text-decoration-line-through ms-2"
                  th:if="${product.discount != null and product.discount > 0}"
                  th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</span>
            <span class="badge bg-danger ms-2"
                  th:if="${product.discount != null and product.discount > 0}"
                  th:text="${'-' + #numbers.formatDecimal(product.discount,0,0) + '%'}">-0%</span>
          </div>

          <form th:action="@{/product/add-to-cart}" method="post">
            <input type="hidden" name="productId" th:value="${product.id}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            
            <div class="mb-3">
              <label class="form-label">Màu sắc</label>
              <div class="d-flex gap-2">
                <input type="radio" class="btn-check" name="color" id="color1" value="Trắng" checked>
                <label class="btn btn-sm btn-outline-secondary" for="color1">Trắng</label>
                <input type="radio" class="btn-check" name="color" id="color2" value="Xanh">
                <label class="btn btn-sm btn-outline-secondary" for="color2">Xanh</label>
                <input type="radio" class="btn-check" name="color" id="color3" value="Hồng">
                <label class="btn btn-sm btn-outline-secondary" for="color3">Hồng</label>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Kích thước</label>
              <div class="d-flex gap-2">
                <input type="radio" class="btn-check" name="size" id="size1" value="S">
                <label class="btn btn-sm btn-outline-dark" for="size1">S</label>
                <input type="radio" class="btn-check" name="size" id="size2" value="M" checked>
                <label class="btn btn-sm btn-outline-dark" for="size2">M</label>
                <input type="radio" class="btn-check" name="size" id="size3" value="L">
                <label class="btn btn-sm btn-outline-dark" for="size3">L</label>
                <input type="radio" class="btn-check" name="size" id="size4" value="XL">
                <label class="btn btn-sm btn-outline-dark" for="size4">XL</label>
              </div>
            </div>

            <div class="d-flex align-items-center gap-3 mb-4">
              <input type="number" name="qty" class="form-control" style="width:140px;" value="1" min="1">
              <button type="submit" class="btn btn-dark">Thêm vào giỏ</button>
            </div>
          </form>

          <div class="border-top pt-3">
            <h6>Mô tả</h6>
            <p class="text-muted mb-0" th:text="${#strings.isEmpty(product.description) ? 'Chưa có mô tả.' : product.description}">Mô tả</p>
          </div>
        </div>
      </div>

      <!-- đánh giá đơn giản -->
      <div class="mt-5">
        <h4 class="mb-3">Đánh giá</h4>
        <div class="border rounded p-3 mb-2" th:each="rv : ${reviews}">
          <div class="d-flex justify-content-between">
            <strong th:text="${rv.account != null ? rv.account.fullName : 'Khách hàng'}">Khách hàng</strong>
            <span class="text-warning" th:text="${#numbers.formatDecimal(rv.rating,0,0)} + '★'"></span>
          </div>
          <p class="mb-0 text-muted" th:text="${rv.comment}">Bình luận</p>
        </div>
        <div class="text-muted" th:if="${#lists.isEmpty(reviews)}">Chưa có đánh giá.</div>
      </div>
    </div>
  </article>
</body>
</html>
