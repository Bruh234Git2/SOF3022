<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: view(~{::title}, ~{::article})}">
<head>
  <title>Chi tiết sản phẩm</title>
</head>
<body>
  <article>
    <div class="container">
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb mb-1">
          <li class="breadcrumb-item"><a th:href="@{/pages/home}">Trang chủ</a></li>
          <li class="breadcrumb-item"><a th:href="@{/pages/product-list}">Sản phẩm</a></li>
          <li class="breadcrumb-item active" aria-current="page">Chi tiết</li>
        </ol>
      </nav>

      <div class="row g-4">
        <!-- gallery -->
        <div class="col-lg-6">
          <div class="card mb-3">
            <img id="mainImage" class="card-img-top" src="https://media.routine.vn/1200x1500/prod/variant/10f25shs008-green-1-jpg-7wdk.webp" alt="product">
          </div>
          <div class="d-flex gap-2">
            <img src="https://media.routine.vn/400x0/prod/variant/10f25shs008-green-1-jpg-7wdk.webp" class="rounded border" style="width:80px; height:80px; object-fit:cover; cursor:pointer" onclick="swapImg(this)">
            <img src="https://product.hstatic.net/1000008082/product/s1_9c03fadfc6ff42fcbdedf9818ea1916c_master.jpeg" class="rounded border" style="width:80px; height:80px; object-fit:cover; cursor:pointer" onclick="swapImg(this)">
            <img src="https://lados.vn/wp-content/uploads/2024/10/kieu-ao-so-mi-ke-soc-nam-jpg.webp" class="rounded border" style="width:80px; height:80px; object-fit:cover; cursor:pointer" onclick="swapImg(this)">
          </div>
        </div>

        <!-- info -->
        <div class="col-lg-6">
          <h2 class="fw-bold">Áo Sơ Mi Nam Smart Shirt</h2>
          <div class="d-flex align-items-center gap-2 mb-2">
            <div class="text-warning">★★★★★</div>
            <small class="text-muted">(128 đánh giá)</small>
          </div>
          <div class="mb-3">
            <span class="fs-4 fw-bold">349.000 đ</span>
            <span class="text-muted text-decoration-line-through ms-2">441.000 đ</span>
            <span class="badge bg-danger ms-2">-20%</span>
          </div>

          <div class="mb-3">
            <label class="form-label">Màu sắc</label>
            <div id="colorGroup" class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-secondary" data-value="Trắng">Trắng</button>
              <button class="btn btn-sm btn-outline-secondary" data-value="Xanh">Xanh</button>
              <button class="btn btn-sm btn-outline-secondary" data-value="Hồng">Hồng</button>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Kích thước</label>
            <div id="sizeGroup" class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-dark" data-value="S">S</button>
              <button class="btn btn-sm btn-outline-dark" data-value="M">M</button>
              <button class="btn btn-sm btn-outline-dark" data-value="L">L</button>
              <button class="btn btn-sm btn-outline-dark" data-value="XL">XL</button>
            </div>
          </div>

          <div class="d-flex align-items-center gap-3 mb-4">
            <div class="input-group" style="width:140px;">
              <button class="btn btn-outline-secondary" type="button" onclick="chgQty(-1)">-</button>
              <input id="qty" type="number" class="form-control text-center" value="1" min="1">
              <button class="btn btn-outline-secondary" type="button" onclick="chgQty(1)">+</button>
            </div>
            <button id="btnAddToCart" type="button" class="btn btn-dark">Thêm vào giỏ</button>
          </div>

          <div class="border-top pt-3">
            <h6>Mô tả</h6>
            <p class="text-muted mb-0">Chất liệu cotton thoáng mát, form slim vừa vặn, phù hợp đi làm và đi chơi. Hướng dẫn giặt: giặt máy chế độ nhẹ, không dùng chất tẩy mạnh.</p>
          </div>
        </div>
      </div>

      <!-- đánh giá đơn giản -->
      <div class="mt-5">
        <h4 class="mb-3">Đánh giá</h4>
        <div class="border rounded p-3 mb-2">
          <div class="d-flex justify-content-between">
            <strong>Minh Anh</strong>
            <span class="text-warning">★★★★★</span>
          </div>
          <p class="mb-0 text-muted">Áo đẹp, chất vải mát, giao nhanh.</p>
        </div>
        <div class="border rounded p-3 mb-2">
          <div class="d-flex justify-content-between">
            <strong>Quang Huy</strong>
            <span class="text-warning">★★★★☆</span>
          </div>
          <p class="mb-0 text-muted">Form hơi ôm, nên tăng 1 size.</p>
        </div>
      </div>
    </div>
  <script>
    function swapImg(el){
      const main = document.getElementById('mainImage');
      const tmp = main.src; main.src = el.src; el.src = tmp;
    }
    function chgQty(delta){
      const i = document.getElementById('qty');
      const v = Math.max(1, (parseInt(i.value||'1')+delta));
      i.value = v;
    }
    function addToCart(item){
      try{
        const cart = JSON.parse(localStorage.getItem('cart')||'[]');
        const idx = cart.findIndex(x=>x.id===item.id);
        if(idx>-1){ cart[idx].qty = (parseInt(cart[idx].qty||1)||1) + item.qty; }
        else { cart.push(item); }
        localStorage.setItem('cart', JSON.stringify(cart));
        // update badge if present
        const badge = document.getElementById('cartCountBadge');
        if(badge){
          const count = cart.reduce((s,i)=>s+(parseInt(i.qty||1)||1),0);
          if(count>0){ badge.style.display='inline-block'; badge.textContent=count; } else { badge.style.display='none'; }
        }
      }catch(e){ console.warn(e); }
    }
    document.addEventListener('DOMContentLoaded', function(){
      // Read product from query string if present
      const qs = new URLSearchParams(window.location.search);
      const qId = qs.get('id');
      const qTitle = qs.get('title');
      const qPrice = qs.get('price');
      const qImg = qs.get('img');
      let product = {
        id: qId || 'detail-001',
        title: qTitle || 'Áo Sơ Mi Nam Smart Shirt',
        price: qPrice ? parseInt(qPrice) : 349000,
        img: qImg || document.getElementById('mainImage')?.src || ''
      };
      // hydrate UI according to query
      try{
        const h2 = document.querySelector('h2.fw-bold');
        if(h2 && qTitle) h2.textContent = qTitle;
        // Update main image
        const mainImg = document.getElementById('mainImage');
        if(mainImg && qImg) mainImg.src = qImg;
        // Update price display
        const priceSpan = document.querySelector('.fw-bold.fs-4, .fs-4.fw-bold');
        if(priceSpan && product.price){ priceSpan.textContent = new Intl.NumberFormat('vi-VN').format(product.price) + ' đ'; }
      }catch(e){ console.warn(e); }
      // chọn màu/size có trạng thái active
      function bindToggle(groupId, activeClass){
        const g = document.getElementById(groupId);
        if(!g) return;
        g.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click', function(){
            g.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
            this.classList.add('active');
          });
        });
      }
      bindToggle('colorGroup');
      bindToggle('sizeGroup');

      const btn = document.getElementById('btnAddToCart');
      if(btn){
        btn.addEventListener('click', function(){
          const qty = Math.max(1, parseInt(document.getElementById('qty').value||'1'));
          // lấy dữ liệu đã parse từ query hoặc UI
          const title = product.title || (document.querySelector('h2.fw-bold')?.textContent?.trim() || 'Sản phẩm');
          const img = product.img || (document.getElementById('mainImage')?.src || '');
          const price = product.price || 349000;
          const id = product.id || 'detail-001';
          const color = document.querySelector('#colorGroup .active')?.dataset?.value || 'Default';
          const size = document.querySelector('#sizeGroup .active')?.dataset?.value || 'M';
          addToCart({id, title, price, img, qty, color, size});
          // feedback và chuyển tới giỏ
          btn.classList.add('btn-success');
          btn.textContent = 'Đã thêm ✓';
          setTimeout(()=>{ window.location.href = '/pages/cart'; }, 600);
        });
      }
    });
  </script>
  </article>
</body>
</html>
